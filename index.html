<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>sketch-006: land wave</title>
  <style>

    * {
      box-sizing: border-box;
    }

    canvas {
      cursor: crosshair;
    }

    html, body {
      margin:0;
      height:100%;
      font-family: sans-serif;
      font-size: 1em;
    }

    form, fieldset {
      padding: 0;
      margin: 0;
      border: 0;
    }

    fieldset {
      /*border-top: 5px solid green;*/
      /*border: 1px solid black;*/
    }

    textarea {
      height: 50%;
      width: 100%;
    }

    .container {
      height: 100%;
      display:flex;
      flex-wrap: nowrap;
      align-items: center;
      /*background-color: rgb(254, 204, 100);*/
    }

    .max-height {
      height:100%;
    }

    .flex {
      display: flex;
    }

    .col {
      flex-direction: column;
    }

    .row {
      flex-direction: row;
    }

    .alg-center {
      justify-content: center;
    }

    legend {
      font-size:.5em;
      /*text-align: center;*/
    }

    .center, .text, .error, img {
      position:absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .img-box {
      height: 100%;
      width: 100%;
      position: relative;
    }

    .img-box h1 {
      padding-left: 10%;
    }

    .img-box p {
      padding-left: 10%;
    }

    button.current {
      color: red;
    }
  
    section {
      padding: 0 2%;
      /*background-color: green;*/
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content: center;
    }

    #output, #toolbox {
      flex: 1 0 25%;
    }

    h1, p {
      padding: 0;
      margin: 0;
    }

    #draw {
      flex: 1 0 50%;
      padding: 2% 0;
    }

    #toolbox label {
      font-size: 0.5em;
    }

    .partout {
      height: 100%;
      padding: 1%;
      /*background-color: orange;*/
    }

    .dashed-border {
      border: 5px dashed lightgrey;
    }

    .radio label {
      font-size:0.5em;
    }
/*for test*/
    .green {
      background-color: green;
    }

    .hide {
      display: none;
    }

    label {
      display: box;
    }

    #zoom {
      width: 100%;
    }


  </style>
</head>
<body>

  <div class="container">

    <section id="output">
      <form name="output">
        <fieldset name="type">
          <legend>Output type</legend>
          <select>
            <option value="p5js">p5.js</option>
            <option value="array">array</option>
            <option value="json">JSON</opton>
            </select>
          <textarea name="output" disabled></textarea>
        </fieldset>
      </form><!-- output -->
      <form name="history" id='hist'>
        <button type="button" name="undo" disabled>undo</button>
        <button type="button" name="history"disabled>redo</button>
        <button type="button" name="clear">clear</button>
        <button type="button" name="copy" disabled>copy to clipboar</button>
        <button type="button" name="save" disabled>save</button>
      </form><!-- history -->
    </section><!--#output-->

    <section id="draw">
      <div class="partout dashed-border">
        <div class="img-box">
          <div class="text">
            <h1>Hello!</h1>
            <p>choose file, make shapes, have a fun with p5.js</p>
            </div>
        </div><!--.img-box-->
      </div><!--.img-wrapper-->
      <form name="coordinates">
        <fieldset>
          <legend>Coordinates/Colors</legend>
                <label>x: <input type="text" name="x" disabled></label>
                <label>y: <input type="text" name="y" disabled></label>
                <label>rgb: <input type="text" name="rgb" disabled></label>
            </fieldset>
          </form><!--coordinates-->
    </section><!--#draw-->


    <section id="toolbox">
        <form class="hide" name="map">
          <fieldset>
            <legend>Map</legend>
            <label>x:<input type="range" name="offsetX" value="0"></label>
            <label>y:<input type="range" name="offsetY" value="0"></label>
            <label>zoom:<input type="range" name="zoom" min="1" max="3" step="0.1" value="1"></label>
            <button type="button" name="reset">reset map</button>
          </fieldset>
        </form>
        <form name="toolbox">
          <fieldset name="file">
            <legend>File</legend>
            <input type="file" id="file">
            <button type='button' name='create'>create canvas</button>
            <button type="button" name="launch">launch</button>
          </fieldset>
          <fieldset name="primitives">
            <legend>2D primitives</legend>
            <label><input type="radio" name="shape" value="triange">triangle</label>
            <label><input type="radio" name="shape" value="ellipse">ellipse</label>
            <label><input type="radio" name="shape" value="line">line</label>
            <label><input type="radio" name="shape" value="curve">curve</label>
            <label><input type="radio" name="shape" value="bezier">bezier</label>
            <label><input type="radio" name="shape" value="arc">arc</label>
          </fieldset>
          <fieldset name="shapes">
            <legend>Shape</legend>
            <label><input type="radio" name="shape" value="line" checked>line</label>
            <label><input type="radio" name="shape" value="bezier">bezier</label>
            <label><input type="radio" name="shape" value="curve">curve</label>
            <label><input type="checkbox" name="closePath">close path</label>
            <button type="button" name="new">new path</button>
          </fieldset>
        </form><!--toolbar-->
        <form>
        <fieldset>
          <legend>show/hide<legend>
          <label><input type="checkbox" name="showImage" checked id="hello">image</label>
          <label><input type="checkbox" name="showShape" checked>shapes</label>
        </fieldset>
      </form>
      </seciton><!--#toolbar-->
    </div><!--.container-->

    <script>

    "use strict"



      let canvas, ctx;
      let arr = []; ///// -->scene

      const $ = str => document.querySelector(str);
      const _ = str => $(`input[name=${str}]`);
      const imgBox = $('.img-box');
      const who = (str) => [].filter.call(
        document.querySelectorAll(`input[name=${str}]`), e =>
          e.checked)[0].value;
      

      const createCanvas = elm => {
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        let box = size(elm);
        canvas.width = box.w;
        canvas.height = box.h;
        removeChildren(elm);
        elm.appendChild(canvas);
        return {
          canvas,
          ctx
        };
      }

      const removeChildren = elm => {
        elm.innerHTML = '';
      }

      const size = elm => ({
        w: elm.clientWidth,
        h: elm.clientHeight
      });

      const btn = {
        create () {
          let obj = createCanvas($('.partout'));
          canvas = obj.canvas;
          ctx = obj.ctx;
          listenCanvas();
        },
        launch () {
          timerFn(draw, 1000/60).start();
        } 
      };

      const shapes = {
        line(e) {
          anchor(e);
        },
        bezier(e) {
          bezer(e);
        }
      }

      const screen = (state) => ({

        drawRect () {
          state.arr.forEach(elm => elm.draw());
        },

        add (pos) {
          let elm;
          if (state.arr.length === 0) {
            elm = anchor({x: pos.x, y: pos.y, type: 'moveTo'});
          } else {
            switch (who('shape')){
              case 'line':
                elm = anchor(pos);
                break;
              case 'bezier':
                elm = bezier({
                  x: pos.x,
                  y: pos.y,
                  sibling: state.arr.slice(-1)[0]
                });
                break;
              default:
                console.log('error...')
              }
            }
          console.log('add new anchor... ', elm);
          state.arr.push(elm);
        },

        clear() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        },

        drawPath () {
          ctx.beginPath();
          ctx.strokeStyle = 'black';
          state.arr.forEach(elm => elm.path());
          if (_('closePath').checked) {
            ctx.closePath();
          }
          ctx.stroke();
        },

        seek (target) {
          let search = state.arr.filter(elm => 
            target.x >= elm.box().left &&
            target.x <= elm.box().right && 
            target.y >= elm.box().top &&
            target.y <= elm.box().bottom
          );
          if (!search.length) {
            return false;
          } else {
            return search[0];
          }
        },

        line (target) {
          let search;
          for (let i = 1; i < state.arr.length; i++) {
            if (Math.abs(len(state.arr[i],state.arr[i-1])
                - len(state.arr[i], target)
                - len(state.arr[i-1], target) 
                ) < 0.5) {
              console.log(state.arr[i]);
              search = state.arr[i];
            }
          };
          
          if (search) {
            return search;
          } else {
            return false;
          };
        }

      });

      const len = (a,b) => Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow (a.y - b.y, 2));

      const scene = screen({arr:arr});

      const rect = {

        box () {
          return {
            left: this.x - this.size/2,
            right: this.x + this.size/2,
            top: this.y - this.size/2,
            bottom: this.y + this.size/2
          }
        },

        draw () {
          let r = this.box();
          ctx.fillStyle = this.color;
          ctx.fillRect(r.left, r.top, this.size, this.size);
          return this;
        },

        move (pos) {
          this.x = pos.x;
          this.y = pos.y;
          this.draw();
        },

        curve (pos) {
          this.px = pos.x;
          this.py = pos.y;
          this.draw();
        },

        path () {
          ctx[this.type](this.px, this.py, this.x, this.y);
        }
      }

      const anchor = (pos) => {
        let state = {
          x: pos.x,
          y: pos.y,
          px: pos.px || pos.x,
          py: pos.py || pos.y,
          type: pos.type || 'quadraticCurveTo',
          size: 10,
          color: pos.color || '#ff0000'
        };

        return Object.assign(
          Object.create(rect),
          state
        );

      };


      const bezierCurve = {

        draw () {
          console.log(this);
          this.main.draw();
          this.first.draw();
          this.second.draw();
        },

        // path        


      };

      const bezier = (pos) => {
        let state = {
          x:pos.x,
          y:pos.y,
          main: anchor({
            x: pos.x,
            y: pos.y
          }),
          sibling: pos.sibling,
          first: anchor({
            x: (pos.x + pos.sibling.x)/2,
            y: (pos.y + pos.sibling.y)/2,
            color: 'blue'
          }),
          second: anchor({
            x: (pos.x + pos.sibling.x)/2,
            y: (pos.y + pos.sibling.y)/2,
            color: 'green'
          }),
          type: 'bezierCurveTo'
        }

        return Object.assign(
          Object.create(bezierCurve),
          state
          );
      }



      const timerFn = (fn, ms) => {

        let id;
        
        const start = () => { id = setInterval(fn, ms)} ; //setInterval
        const stop = () => { clearInterval(id)};
        
        return {
          start: start,
          stop: stop
        }
      };


      const draw = () => {
        scene.clear();
        scene.drawPath();
        scene.drawRect();
      }

      document.body.addEventListener('click', e => {
        if (e.target.type === 'button') {
          btn[e.target.name]();
        }
      });

      const mouseXY = e => {
        let r = canvas.getBoundingClientRect(e);
        return {
          x: e.clientX - Math.floor(r.left),
          y: e.clientY - Math.floor(r.top)
        };
      };


      const pixelXY = pos => ctx.getImageData(pos.x, pos.y, 1,1).data;

      const listenCanvas = () => {

        let mouseOverCanvas = false;
        let mouse;
        let dragElm = null;
        let dragLine = null;
        let flag = true;


        canvas.addEventListener('click', e => {
          if (dragElm || dragLine) {
            dragElm = null;
            dragLine = null;
          } else {
            scene.add(anchor(mouse));
          } 

        });

        canvas.addEventListener('mousedown', () => {
          let e = scene.seek(mouse);
          let l = scene.line(mouse);
          if (e) {
            dragElm = e;
          } else {
            if (l) {
              dragLine = l;
            }
          }
        });

        canvas.addEventListener('mouseup', () => {

        });

        canvas.addEventListener('mousemove', e => {
          mouse = mouseXY(e);
                  
          if (scene.seek(mouse) || scene.line(mouse)) {
            canvas.style.cursor = 'pointer';
          } else {
            canvas.style.cursor = 'crosshair';
          }
          _('x').value = mouse.x;
          _('y').value = mouse.y;
          _('rgb').value = pixelXY(mouse);
          if (dragElm !== null) {
            dragElm.move(mouse);
          }
          if (dragLine !== null) {
            dragLine.curve(mouse);
          }
        });

        canvas.addEventListener('mouseover', () => {
          mouseOverCanvas = true;
        });

        canvas.addEventListener('mouseout', () => {
          mouseOverCanvas = false;
        });
    }

    </script>


  </body>
</html>