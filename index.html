<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>sketch-006: land wave</title>
  <style>

    * {
      box-sizing: border-box;
    }

    html, body {
      margin:0;
      height:100%;
      font-family: sans-serif;
      font-size: 1em;
    }

    form, fieldset {
      padding: 0;
      margin: 0;
      border: 0;
    }

    fieldset {
      /*border-top: 5px solid green;*/
      /*border: 1px solid black;*/
    }

    textarea {
      height: 50%;
      width: 100%;
    }

    .container {
      height: 100%;
      display:flex;
      flex-wrap: nowrap;
      align-items: center;
      /*background-color: rgb(254, 204, 100);*/
    }

    .max-height {
      height:100%;
    }

    .flex {
      display: flex;
    }

    .col {
      flex-direction: column;
    }

    .row {
      flex-direction: row;
    }

    .alg-center {
      justify-content: center;
    }

    legend {
      font-size:.5em;
      /*text-align: center;*/
    }

    .center, .text, .error, img {
      position:absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .img-box {
      height: 100%;
      position: relative;
    }

    .img-box h1 {
      padding-left: 10%;
    }

    .img-box p {
      padding-left: 10%;
    }

    button.current {
      color: red;
    }
  
    section {
      padding: 0 2%;
      /*background-color: green;*/
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content: center;
    }

    #output, #toolbox {
      flex: 1 0 25%;
    }

    h1, p {
      padding: 0;
      margin: 0;
    }

    #draw {
      flex: 1 0 50%;
      padding: 2% 0;
    }

    #toolbox label {
      font-size: 0.5em;
    }

    .partout {
      height: 100%;
      padding: 1%;
      /*background-color: orange;*/
    }

    .dashed-border {
      border: 5px dashed lightgrey;
    }

    .radio label {
      font-size:0.5em;
    }
/*for test*/
    .green {
      background-color: green;
    }

    .hide {
      display: none;
    }

    label {
      display: box;
    }

    #zoom {
      width: 100%;
    }


  </style>
</head>
<body>

  <div class="container">

    <section id="output">
      <form name="output">
        <fieldset name="type">
          <legend>Output type</legend>
          <select>
            <option value="p5js">p5.js</option>
            <option value="array">array</option>
            <option value="json">JSON</opton>
            </select>
          <textarea name="output" disabled></textarea>
        </fieldset>
      </form><!-- output -->
      <form name="history">
        <button type="button" name="undo" disabled>undo</button>
        <button type="button" name="history"disabled>redo</button>
        <button type="button" name="clear">clear</button>
        <button type="button" name="copy" disabled>copy to clipboar</button>
        <button type="button" name="save" disabled>save</button>
      </form><!-- history -->
    </section><!--#output-->

    <section id="draw">
      <div class="partout dashed-border">
        <div class="img-box">
          <div class="text">
            <h1>Hello!</h1>
            <p>choose file, make shapes, have a fun with p5.js</p>
            </div>
        </div><!--.img-box-->
      </div><!--.img-wrapper-->
      <form name="coordinates">
        <fieldset>
          <legend>Coordinates/Colors</legend>
                <label>x: <input type="text" name="x" disabled></label>
                <label>y: <input type="text" name="y" disabled></label>
                <label>rgb: <input type="text" name="rgb" disabled></label>
            </fieldset>
          </form><!--coordinates-->
    </section><!--#draw-->


    <section id="toolbox">
                <canvas id="zoom"></canvas>
        <form class="hide" name="map">
          <fieldset>
            <legend>Map</legend>
            <label>x:<input type="range" name="offsetX" value="0"></label>
            <label>y:<input type="range" name="offsetY" value="0"></label>
            <label>zoom:<input type="range" name="zoom" min="1" max="3" step="0.1" value="1"></label>
            <button type="button" name="reset">reset map</button>
          </fieldset>
        </form>
        <form name="toolbox">
          <fieldset name="file">
            <legend>File</legend>
            <input type="file" id="file">
          </fieldset>
<!--           <fieldset name="primitives">
            <legend>2D primitives</legend>
            <label><input type="radio" name="shape" value="triange">triangle</label>
            <label><input type="radio" name="shape" value="ellipse">ellipse</label>
            <label><input type="radio" name="shape" value="line">line</label>
            <label><input type="radio" name="shape" value="curve">curve</label>
            <label><input type="radio" name="shape" value="bezier">bezier</label>
            <label><input type="radio" name="shape" value="arc">arc</label>
          </fieldset> -->
          <fieldset name="shapes">
            <legend>Shape</legend>
            <label><input type="radio" name="shape" value="line" checked>line</label>
            <label><input type="radio" name="shape" value="bezier">bezier</label>
            <!-- <label><input type="radio" name="shape" value="curve">curve</label> -->
            <button type="button" name="new">new path</button>
          </fieldset>
        </form><!--toolbar-->
        <form>
        <fieldset>
          <legend>show/hide<legend>
          <label><input type="checkbox" name="showImage" checked>image</label>
          <label><input type="checkbox" name="showShape" checked>shapes</label>
        </fieldset>
      </form>
    </seciton><!--#toolbar-->

</div><!--.wrapper-->
<!-- <script src='js/p5.js'></script> -->
  <!-- // <script src='js/main.js'></script> -->

<script>

  "use strict"

  let over = false;  // mouse over canvas
  const error = '<h1>Hey</h1><p>I\'m understand only img file types...</p>';
  const imgBox = document.querySelector('.img-box');
  const imgBtn = document.querySelector('#file');
  let click, prevClick;
  let w = window.innerWidth;
  let h = window.innerHeight;
  let ds = [[]]; // shapes list
  let tmp = {};
  let mouseX, mouseY;
  let img, canvas, ctx;
  let x = document.forms.coordinates.elements.x;
  let y = document.forms.coordinates.elements.y;
  let zoom;

  const drawPoint = state => {ctx[state.type].apply(ctx, state.param)};

  function $(elm){ 
    return document.querySelector(elm);
  }
  
  test();

  const setAttribute = (elm, atr, val) => { elm[atr] = val; };

  const getAttribute = (elm, atr) => elm[atr];

  const map = () => ({
    offsetX: getAttribute($('input[name=offsetX]'), 'value'),
    offsetY: getAttribute($('input[name=offsetY]'), 'value'),
    zoom: getAttribute($('input[name=zoom]'), 'value'),
    showImage: getAttribute($('input[name=showImage]'), 'checked'),
    showShape: getAttribute($('input[name=showShape]'), 'checked')
  });

  const btnEvents = {
    new: () => { ds.push([])},
    clear: () => { ds = [[]]},
    reset: () => {
      setAttribute($('input[name=offsetX]'), 'value', 0);
      setAttribute($('input[name=offsetY]'), 'value', 0);
      setAttribute($('input[name=zoom]'), 'value', 1);
    },

  }

// str --> [element,..]
// get value of checked elements by name
// css selector input[name=name]:checked

const checkedIn = name => document.querySelector(`input[name=${name}]:checked`).value;

function render(){
  ds.forEach(arr => { 
    ctx.beginPath();
    arr.forEach(obj => {drawPoint(obj)})
    ctx.strokeStyle = 'green';
    ctx.lineWidth = .5;
    ctx.stroke();
    ctx.closePath();
  });
}

function renderTmp() {
  ctx.beginPath();
    if (tmp.type === undefined && over) {
      ctx.moveTo(click.x, click.y)
      ctx.lineTo(x.value, y.value);
    } else {
      ctx.moveTo(prevClick.x, prevClick.y);
      tmp.param = [mouseX,mouseY].concat(tmp.param.slice(2));
      drawPoint(tmp);
    }
  ctx.strokeStyle = 'red';
  ctx.lineWidth = .5;
  ctx.stroke();
}

function draw() {
  let d = map();
  ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width, canvas.height);
  if (d.showImage){
    ctx.drawImage(img, d.offsetX*d.zoom, d.offsetY*d.zoom, canvas.width*d.zoom, canvas.height*d.zoom);}
  if (d.showShape) {
    render();
  if (last(ds).length > 0) {
    renderTmp();
  }
}
}



function test() {
  let a = timerFn(draw, 1000/60);
  a.start();
}


// function --> Integer --> Object
// call fn every ms

function timerFn(fn, ms) {

  let id;
  const start = () => { id = setInterval(fn, ms)} ;
  const stop = () => { clearInterval(id)};
  return {
    start: start,
    stop: stop
  }
}



////////////////////////////////////
// load-image
////////////////////////////////////


// listen event 'change' on imgBtn (input[type=file])
// onchange call handleFile

  imgBtn.addEventListener('change', handleFile);

// sendMsd :: string element --> null
// remove all from element 'to', make new 'div', add class 'error'
// add msg, put it inside element 'to'

  function sendMsg(msg, to) { 
    let err = document.createElement('div');
    err.className = 'error';
    err.innerHTML = msg;
    imgBox.innerHTML = '';
    imgBox.appendChild(err);
  }

// isImage :: string --> bool
// return true if filetype image

  function isImage(filetype) {
    return /^image/.test(filetype);
  }


//  getSize :: element --> object
//  return width and height of the element

  function getSize(elm) {
    if (elm.clientHeight){
      return {
        w: elm.clientWidth,
        h: elm.clientHeight
      }
    } else {
      return {
        w: elm.width,
        h: elm.height
      }
    }
  }

// fitSize object --> object --> object
// resize 'a' to fit in 'b'

  function fitSize(a, b) {
    let rate = a.w / a.h;
    if (a.w > b.w) {
      a.h -= (a.w - b.w) / rate;
    } else {
      a.h += (b.w - a.w) / rate;
    }
    a.w = b.w;  
    if (a.h > b.h) {
      a.w -= (a.h - b.h) * rate;
      a.h -= a.h - b.h;
    } 
    a.w = Math.ceil(a.w);
    a.h = Math.ceil(a.h);    
    return a;
  
  }

// handleFile event --> img
// if event 'change' on input[type=file]
// if filetype image make new image and add to canvas

  function handleFile() {   
    let file = this.files[0];
    if ( !isImage(file.type) ) {
      sendMsg(error, imgBox);
    } else {
      img = new Image();
      img.src = window.URL.createObjectURL(file);     
      img.onload = function(){
        window.URL.revokeObjectURL(this.src);
        drawImg(this); // when img loaded... put it in canvas
      }
    }
  }

  function drawImg(img) {
    let size = fitSize(getSize(img),getSize(imgBox));
    canvas = document.createElement('canvas');
    ctx =  canvas.getContext('2d');
    ctx.canvas.width = size.w;
    ctx.canvas.height = size.h;
    ctx.drawImage(img, 0, 0, size.w, size.h);
    imgBox.innerHTML = '';
    canvas.className += 'center';
    imgBox.appendChild(canvas);
    document.forms.map.style.display = "block";
    setRange('input[name=offsetX]', size.w);
    setRange('input[name=offsetY]', size.h);
    zoom = $('#zoom').getContext('2d');
    mouseXY();
  }

  function setRange(str, value){
    console.log(value)
    let elm = document.querySelector(str);
    elm.min = -value;
    elm.max = value;
    console.log(elm);
  }

  const last = arr => arr[arr.length - 1];

  function whoami (){
    prevClick = click;
    click = {x: x.value, y: y.value };
    let arr = last(ds); // get last elm in ds
    if (!arr.length) {  // if arr empty
      arr.push({ type: 'moveTo', param: [x.value, y.value] });
    } else {
      if (checkedIn('shape') === 'bezier'){
        if (tmp.type === undefined) {
          tmp = {
            type: 'quadraticCurveTo',
            param: [prevClick.x, prevClick.y, click.x, click.y]
          };
        } else {
          arr.push(tmp);
          click = prevClick;
          tmp = {};
        };
      } else {
      arr.push({
        type: 'lineTo',
        param: [x.value, y.value]
      });
      }
    }
  }



////////////////////////////////////////////////


// mouseXY
// when mouse over canvas
// get mouse position
// update coordinates values
// change cursor style
// event canvas.onclick 

function mouseXY(){


  document.addEventListener('mousemove', e => {
    let size = canvas.getBoundingClientRect();
    let pixel;
    // let imgData;
    mouseX = e.clientX - Math.floor(size.left);
    mouseY = e.clientY - Math.floor(size.top);
    pixel = ctx.getImageData(mouseX, mouseY, 1,1).data;
    // imgData = ctx.getImageData(mouseX,mouseY, 10,10);
    if (over) {
      x.value = mouseX;
      y.value = mouseY;
      $('input[name=rgb').value = pixel;
      $('body').style.backgroundColor = `rgba(${pixel})`;
      // console.log(canvas);
      // console.log(zoom);
      // zoom.putImageData(imgData,30,30);
        
    }
  });

  canvas.addEventListener('click', function(){
    if (over) {
      whoami();
    }
  });

  canvas.addEventListener('mouseover', function(){
    over = true;
    this.style.cursor = 'crosshair';
  });

  canvas.addEventListener('mouseout', function(){
    over = false;
    this.style.cursor = 'pointer';
    // x.value = '';
    // y.value = '';
  });
}


for (let i=0; i < document.forms.length; i++) {
  document.forms[i].addEventListener('click', e => {
    // console.log(e.target.name);
    if (e.target.type === 'button') {
      btnEvents[e.target.name]();
    }
  });
}


// document.body.addEventListener('input', e => {
//       if (e.target.type === 'range') {
//         map[e.target.name] = e.target.value;
//       }
//     });

// document.body.addEventListener('change', e => {
//       if (e.target.type === 'checkbox') {
//         // console.log(e.target.checked);
//         map[e.target.name] = e.target.checked;
//       }
//   });

  </script>
</body>
</html>